<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0A0A0F">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>NEXUS • Quantum School Transport</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        /* === FUTURISTIC DESIGN SYSTEM === */
        :root {
            --cyber-blue: #00D4FF;
            --neon-purple: #B026FF;
            --matrix-green: #00FF9D;
            --warning-orange: #FF6B35;
            --critical-red: #FF375F;
            --dark-space: #0A0A0F;
            --deep-space: #12121D;
            --mid-space: #1A1A2E;
            --light-space: #25253E;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glow-blue: 0 0 30px rgba(0, 212, 255, 0.4);
            --glow-purple: 0 0 30px rgba(176, 38, 255, 0.4);
            --glow-green: 0 0 30px rgba(0, 255, 157, 0.4);
        }

        /* === RESET & BASE === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--dark-space);
            color: #fff;
            overscroll-behavior: none;
            position: fixed;
        }

        /* === FONTS & TYPOGRAPHY === */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        .font-mono {
            font-family: 'SF Mono', 'Courier New', monospace;
        }

        /* === CYBER GLASS EFFECT === */
        .cyber-glass {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.05) 0%, 
                rgba(255, 255, 255, 0.02) 100%);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            position: relative;
            overflow: hidden;
        }

        .cyber-glass::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                var(--cyber-blue), 
                var(--neon-purple), 
                transparent);
            opacity: 0.5;
        }

        /* === NEON GLOW EFFECTS === */
        .neon-glow-blue {
            box-shadow: var(--glow-blue);
            border-color: rgba(0, 212, 255, 0.3) !important;
        }

        .neon-glow-purple {
            box-shadow: var(--glow-purple);
            border-color: rgba(176, 38, 255, 0.3) !important;
        }

        .neon-glow-green {
            box-shadow: var(--glow-green);
            border-color: rgba(0, 255, 157, 0.3) !important;
        }

        /* === LOGIN SCREEN - FUTURISTIC === */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, 
                var(--deep-space) 0%, 
                var(--dark-space) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 9999;
            overflow-y: auto;
        }

        .login-wrapper {
            width: 100%;
            max-width: 480px;
            padding: 40px;
            position: relative;
        }

        .cyber-grid-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(0, 212, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
            border-radius: 24px;
            opacity: 0.3;
        }

        .nexus-logo {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .nexus-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, var(--cyber-blue), var(--neon-purple));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            position: relative;
            animation: float 6s ease-in-out infinite;
        }

        .nexus-icon::after {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(45deg, var(--cyber-blue), var(--neon-purple), var(--matrix-green));
            border-radius: 22px;
            z-index: -1;
            filter: blur(10px);
            opacity: 0.6;
        }

        .nexus-title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--cyber-blue), var(--neon-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
        }

        .nexus-subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            font-weight: 400;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* === HOLOGRAPHIC ROLE SELECTOR === */
        .hologram-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 32px;
            perspective: 1000px;
        }

        .hologram-card {
            padding: 24px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
        }

        .hologram-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, 
                rgba(0, 212, 255, 0.1), 
                rgba(176, 38, 255, 0.1));
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .hologram-card.active {
            transform: translateZ(20px);
            border-color: var(--cyber-blue);
            box-shadow: var(--glow-blue);
        }

        .hologram-card.active::before {
            opacity: 1;
        }

        .hologram-icon {
            font-size: 28px;
            margin-bottom: 12px;
            color: var(--cyber-blue);
            text-shadow: 0 0 20px currentColor;
        }

        .hologram-card.active .hologram-icon {
            color: var(--cyber-blue);
            animation: pulse 2s infinite;
        }

        /* === CYBER INPUTS === */
        .cyber-input-group {
            margin-bottom: 24px;
        }

        .cyber-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .cyber-input {
            width: 100%;
            padding: 18px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            color: white;
            font-size: 16px;
            font-weight: 400;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .cyber-input:focus {
            outline: none;
            border-color: var(--cyber-blue);
            box-shadow: var(--glow-blue);
            background: rgba(0, 212, 255, 0.05);
        }

        .cyber-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        /* === QUANTUM BUTTON === */
        .quantum-btn {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, var(--cyber-blue), var(--neon-purple));
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .quantum-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.2), 
                transparent);
            transition: left 0.5s ease;
        }

        .quantum-btn:hover::before {
            left: 100%;
        }

        .quantum-btn:active {
            transform: scale(0.98);
        }

        /* === INTERFACE COMMON === */
        .interface {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            background: var(--dark-space);
        }

        .interface.active {
            display: block;
        }

        /* === NEURAL HEADER === */
        .neural-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            background: rgba(10, 10, 15, 0.8);
            backdrop-filter: blur(40px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nexus-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--cyber-blue), var(--neon-purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .brand-text h1 {
            font-size: 18px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--cyber-blue), #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .brand-text p {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            letter-spacing: 1px;
        }

        .neural-actions {
            display: flex;
            gap: 8px;
        }

        .hologram-btn {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .hologram-btn.active {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--cyber-blue);
            color: var(--cyber-blue);
        }

        .hologram-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow-blue);
        }

        /* === QUANTUM DASHBOARD === */
        .quantum-dashboard {
            position: fixed;
            top: 100px;
            left: 24px;
            right: 24px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            z-index: 1000;
        }

        .quantum-card {
            padding: 20px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 120px;
            position: relative;
            overflow: hidden;
        }

        .quantum-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--cyber-blue), var(--neon-purple));
        }

        .card-icon {
            font-size: 24px;
            color: var(--cyber-blue);
            filter: drop-shadow(0 0 10px currentColor);
        }

        .card-value {
            font-size: 32px;
            font-weight: 800;
            color: white;
            line-height: 1;
        }

        .card-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* === HOLOGRAPHIC STUDENT MANAGEMENT === */
        .holo-management {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(50px);
            z-index: 2000;
            padding: 40px 24px 24px;
            transform: translateY(100%);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
        }

        .holo-management.active {
            transform: translateY(0);
        }

        .holo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .holo-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--cyber-blue), #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .holo-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .holo-action-btn {
            padding: 16px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .holo-action-btn.primary {
            background: linear-gradient(135deg, var(--cyber-blue), var(--neon-purple));
            border: none;
        }

        /* === STUDENT HOLO-CARDS === */
        .student-holo-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .student-holo-card {
            padding: 20px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
        }

        .student-holo-card:hover {
            transform: translateX(4px);
            border-color: var(--cyber-blue);
        }

        .student-holo-avatar {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--cyber-blue), var(--neon-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
            position: relative;
        }

        .student-holo-avatar::after {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(45deg, var(--cyber-blue), var(--neon-purple));
            border-radius: 18px;
            z-index: -1;
            filter: blur(8px);
            opacity: 0.5;
        }

        .student-holo-info {
            flex: 1;
        }

        .student-holo-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            color: white;
        }

        .student-holo-details {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            display: flex;
            gap: 8px;
        }

        .student-holo-status {
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .status-cyber-waiting {
            background: rgba(255, 107, 53, 0.15);
            color: var(--warning-orange);
            border: 1px solid rgba(255, 107, 53, 0.3);
        }

        .status-cyber-onbus {
            background: rgba(0, 255, 157, 0.15);
            color: var(--matrix-green);
            border: 1px solid rgba(0, 255, 157, 0.3);
        }

        .status-cyber-dropped {
            background: rgba(176, 38, 255, 0.15);
            color: var(--neon-purple);
            border: 1px solid rgba(176, 38, 255, 0.3);
        }

        /* === PARENT HOLO-INTERFACE === */
        .parent-holo-panel {
            position: fixed;
            bottom: 24px;
            left: 24px;
            right: 24px;
            padding: 24px;
            border-radius: 24px;
            z-index: 1000;
        }

        .child-holo-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.03);
            margin-bottom: 20px;
        }

        .child-holo-avatar {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--cyber-blue), var(--neon-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 700;
        }

        .child-holo-details {
            flex: 1;
        }

        .child-holo-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
            color: white;
        }

        .child-holo-info {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .child-holo-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .holo-action-btn.small {
            padding: 14px;
            font-size: 13px;
        }

        /* === CYBER MAP CONTROLS === */
        .cyber-map-controls {
            position: fixed;
            bottom: 200px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }

        .cyber-control-btn {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .cyber-control-btn.active {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--cyber-blue);
            color: var(--cyber-blue);
            box-shadow: var(--glow-blue);
        }

        .cyber-control-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--glow-blue);
        }

        /* === QUANTUM MODAL === */
        .quantum-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(40px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .quantum-modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-holo-content {
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            border-radius: 24px;
            padding: 40px;
            position: relative;
        }

        .modal-holo-content::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, 
                rgba(0, 212, 255, 0.1), 
                rgba(176, 38, 255, 0.1));
            border-radius: 24px;
            z-index: -1;
        }

        /* === NEURAL NOTIFICATIONS === */
        .neural-notifications {
            position: fixed;
            bottom: 24px;
            left: 24px;
            right: 24px;
            z-index: 4000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .neural-toast {
            padding: 20px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 16px;
            animation: slideInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(100px);
            opacity: 0;
        }

        .neural-toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-holo-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast-holo-success .toast-holo-icon {
            background: rgba(0, 255, 157, 0.15);
            color: var(--matrix-green);
        }

        .toast-holo-error .toast-holo-icon {
            background: rgba(255, 55, 95, 0.15);
            color: var(--critical-red);
        }

        .toast-holo-warning .toast-holo-icon {
            background: rgba(255, 107, 53, 0.15);
            color: var(--warning-orange);
        }

        .toast-holo-info .toast-holo-icon {
            background: rgba(0, 212, 255, 0.15);
            color: var(--cyber-blue);
        }

        /* === QUANTUM PULSE ANIMATION === */
        .quantum-pulse {
            position: relative;
        }

        .quantum-pulse::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: inherit;
            background: inherit;
            filter: blur(8px);
            opacity: 0.6;
            animation: pulse 2s infinite;
        }

        /* === ANIMATIONS === */
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 0.2; }
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes cyberScan {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(200%) rotate(45deg); }
        }

        @keyframes hologramFlicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* === MAP STYLES === */
        .map-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .leaflet-container {
            background: var(--dark-space) !important;
        }

        .leaflet-control-attribution {
            background: rgba(0, 0, 0, 0.8) !important;
            color: rgba(255, 255, 255, 0.5) !important;
            font-size: 10px !important;
        }

        /* === RESPONSIVE DESIGN === */
        @media (max-width: 768px) {
            .quantum-dashboard {
                grid-template-columns: 1fr;
                top: 90px;
            }
            
            .hologram-selector {
                grid-template-columns: 1fr;
            }
            
            .login-wrapper {
                padding: 24px;
            }
            
            .nexus-title {
                font-size: 2rem;
            }
        }

        @media (max-height: 600px) {
            .quantum-card {
                min-height: 100px;
                padding: 16px;
            }
            
            .card-value {
                font-size: 24px;
            }
        }

        /* === SCROLLBAR STYLING === */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--cyber-blue), var(--neon-purple));
            border-radius: 4px;
        }

        /* === SAFE AREA SUPPORT === */
        .safe-area-top {
            padding-top: env(safe-area-inset-top, 0px);
        }

        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }
    </style>
</head>
<body>
    <!-- Quantum Login Interface -->
    <div class="login-container" id="loginScreen">
        <div class="login-wrapper cyber-glass">
            <div class="cyber-grid-bg"></div>
            
            <div class="nexus-logo">
                <div class="nexus-icon quantum-pulse">
                    <i class="fas fa-atom"></i>
                </div>
                <h1 class="nexus-title">NEXUS</h1>
                <p class="nexus-subtitle">Quantum School Transport System</p>
            </div>
            
            <div class="hologram-selector">
                <div class="hologram-card active" id="driverRoleBtn">
                    <div class="hologram-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <span>Operator</span>
                    <div class="font-mono" style="font-size: 11px; opacity: 0.6; margin-top: 4px;">
                        DRIVER PROTOCOL
                    </div>
                </div>
                <div class="hologram-card" id="parentRoleBtn">
                    <div class="hologram-icon">
                        <i class="fas fa-user-astronaut"></i>
                    </div>
                    <span>Guardian</span>
                    <div class="font-mono" style="font-size: 11px; opacity: 0.6; margin-top: 4px;">
                        PARENT PROTOCOL
                    </div>
                </div>
            </div>
            
            <div class="cyber-input-group">
                <label class="cyber-label" id="loginLabel">Operator ID</label>
                <input type="text" class="cyber-input" id="loginInput" 
                       placeholder="Enter neural ID" value="OP-001">
                <div class="font-mono" style="font-size: 11px; margin-top: 4px; opacity: 0.5;">
                    Neural ID recognized
                </div>
            </div>
            
            <div class="cyber-input-group">
                <label class="cyber-label">Vehicle Code</label>
                <input type="text" class="cyber-input" id="busNumber" 
                       placeholder="e.g., VH-001-QUANTUM" value="VH-001">
            </div>
            
            <div class="cyber-input-group" id="parentExtra" style="display: none;">
                <label class="cyber-label">Guardian Protocol</label>
                <input type="text" class="cyber-input" id="parentName" 
                       placeholder="Designation" value="GUARDIAN-ALPHA">
                <div style="margin-top: 16px;">
                    <label class="cyber-label">Ward Neural ID</label>
                    <input type="text" class="cyber-input" id="studentId" 
                           placeholder="e.g., WARD-001-ALPHA" value="WARD-001">
                </div>
            </div>
            
            <button class="quantum-btn" id="loginBtn">
                <i class="fas fa-bolt"></i> INITIATE QUANTUM LINK
            </button>
            
            <div class="font-mono" style="text-align: center; margin-top: 24px; font-size: 11px; opacity: 0.4;">
                <i class="fas fa-shield-alt"></i> NEXUS SECURITY PROTOCOL ACTIVE
            </div>
        </div>
    </div>

    <!-- Operator Interface -->
    <div class="interface" id="driverInterface">
        <div class="map-container" id="driverMap"></div>
        
        <div class="neural-header safe-area-top">
            <div class="nexus-brand">
                <div class="brand-icon">
                    <i class="fas fa-atom"></i>
                </div>
                <div class="brand-text">
                    <h1 id="driverBusName">VH-001</h1>
                    <p>OPERATOR MODE • <span class="font-mono" id="currentTime">--:--:--</span></p>
                </div>
            </div>
            <div class="neural-actions">
                <button class="hologram-btn" id="notificationsBtn" title="Neural Feed">
                    <i class="fas fa-satellite-dish"></i>
                    <span class="notification-badge" id="notificationCount" style="display: none;"></span>
                </button>
                <button class="hologram-btn" id="driverLogout" title="Disconnect">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </div>

        <div class="quantum-dashboard">
            <div class="quantum-card cyber-glass neon-glow-blue">
                <div class="card-icon">
                    <i class="fas fa-tachometer-alt-fast"></i>
                </div>
                <div class="card-value font-mono" id="currentSpeed">0</div>
                <div class="card-label">VELOCITY (KM/H)</div>
                <div class="font-mono" style="font-size: 10px; opacity: 0.5;">QUANTUM STABLE</div>
            </div>
            
            <div class="quantum-card cyber-glass neon-glow-green">
                <div class="card-icon">
                    <i class="fas fa-users-between-lines"></i>
                </div>
                <div class="card-value" id="studentsCount">0/0</div>
                <div class="card-label">WARDS ON BOARD</div>
                <div class="font-mono" style="font-size: 10px; opacity: 0.5;">BIOMETRIC ACTIVE</div>
            </div>
            
            <div class="quantum-card cyber-glass neon-glow-purple">
                <div class="card-icon">
                    <i class="fas fa-location-crosshairs"></i>
                </div>
                <div class="card-value" id="nextStopName">--</div>
                <div class="card-label">NEXT INTERCEPT</div>
                <div class="font-mono" style="font-size: 10px; opacity: 0.5;">AWAITING COORDINATES</div>
            </div>
        </div>

        <div class="cyber-map-controls">
            <button class="cyber-control-btn" id="centerMap" title="Sync Coordinates">
                <i class="fas fa-crosshairs"></i>
            </button>
            <button class="cyber-control-btn" id="zoomIn" title="Enhance View">
                <i class="fas fa-search-plus"></i>
            </button>
            <button class="cyber-control-btn" id="zoomOut" title="Reduce View">
                <i class="fas fa-search-minus"></i>
            </button>
            <button class="cyber-control-btn" id="showStudents" title="Ward Management">
                <i class="fas fa-user-helmet-safety"></i>
            </button>
            <button class="cyber-control-btn" id="startTrip" title="Initiate Protocol">
                <i class="fas fa-play"></i>
            </button>
        </div>
    </div>

    <!-- Guardian Interface -->
    <div class="interface" id="parentInterface">
        <div class="map-container" id="parentMap"></div>
        
        <div class="neural-header safe-area-top">
            <div class="nexus-brand">
                <div class="brand-icon">
                    <i class="fas fa-atom"></i>
                </div>
                <div class="brand-text">
                    <h1>NEXUS</h1>
                    <p>GUARDIAN MODE • <span class="font-mono" id="parentTime">--:--:--</span></p>
                </div>
            </div>
            <div class="neural-actions">
                <button class="hologram-btn" id="parentNotificationsBtn" title="Alerts">
                    <i class="fas fa-radar"></i>
                    <span class="notification-badge" id="parentNotificationCount" style="display: none;"></span>
                </button>
                <button class="hologram-btn" id="parentLogout" title="Disconnect">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </div>

        <div class="parent-holo-panel cyber-glass neon-glow-blue">
            <div class="child-holo-card">
                <div class="child-holo-avatar" id="childAvatar">
                    W
                </div>
                <div class="child-holo-details">
                    <div class="child-holo-name" id="childFullName">WARD ALPHA</div>
                    <div class="child-holo-info">
                        <span><i class="fas fa-school"></i> QUANTUM ACADEMY</span>
                        <span class="font-mono">•</span>
                        <span>PROTOCOL: <span id="childSchool">GRADE 5</span></span>
                    </div>
                    <div class="child-holo-info">
                        <i class="fas fa-location-dot"></i>
                        <span id="childLocation">COORDINATES SYNCHING...</span>
                    </div>
                </div>
                <div class="student-holo-status status-cyber-waiting" id="childStatusBadge">
                    AWAITING
                </div>
            </div>
            
            <div class="child-holo-actions">
                <button class="holo-action-btn primary small" id="markPickedBtn">
                    <i class="fas fa-check-circle"></i> CONFIRM INTERCEPT
                </button>
                <button class="holo-action-btn small" id="markDroppedBtn">
                    <i class="fas fa-house-signal"></i> CONFIRM DELIVERY
                </button>
            </div>
        </div>

        <div class="cyber-map-controls">
            <button class="cyber-control-btn" id="parentCenterMap" title="Track Vehicle">
                <i class="fas fa-satellite"></i>
            </button>
            <button class="cyber-control-btn" id="parentZoomIn">
                <i class="fas fa-search-plus"></i>
            </button>
            <button class="cyber-control-btn" id="parentZoomOut">
                <i class="fas fa-search-minus"></i>
            </button>
            <button class="cyber-control-btn active" id="showRoute">
                <i class="fas fa-route"></i>
            </button>
        </div>
    </div>

    <!-- Holo Student Management -->
    <div class="holo-management" id="studentManagement">
        <div class="holo-header">
            <h2 class="holo-title"><i class="fas fa-user-helmet-safety"></i> WARD MANAGEMENT</h2>
            <button class="hologram-btn" id="closeStudentManagement">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="holo-actions">
            <button class="holo-action-btn primary" id="addStudentBtn">
                <i class="fas fa-plus-circle"></i> ENROLL WARD
            </button>
            <button class="holo-action-btn" id="importStudentsBtn">
                <i class="fas fa-database"></i> BATCH IMPORT
            </button>
        </div>
        
        <div class="student-holo-list" id="studentListContainer">
            <!-- Wards will be loaded here -->
        </div>
    </div>

    <!-- Quantum Modal -->
    <div class="quantum-modal" id="addStudentModal">
        <div class="modal-holo-content cyber-glass">
            <div style="text-align: center; margin-bottom: 32px;">
                <div class="hologram-icon" style="font-size: 32px; margin-bottom: 16px;">
                    <i class="fas fa-user-plus"></i>
                </div>
                <h2 class="holo-title">ENROLL NEW WARD</h2>
                <p class="font-mono" style="opacity: 0.6; margin-top: 8px;">NEURAL PROTOCOL REQUIRED</p>
            </div>
            
            <form id="addStudentForm">
                <div class="cyber-input-group">
                    <label class="cyber-label">WARD NEURAL ID</label>
                    <input type="text" class="cyber-input" id="newStudentId" 
                           placeholder="e.g., WARD-001-ALPHA" required>
                </div>
                
                <div class="cyber-input-group">
                    <label class="cyber-label">DESIGNATION</label>
                    <input type="text" class="cyber-input" id="newStudentName" 
                           placeholder="Ward Designation" required>
                </div>
                
                <div class="cyber-input-group">
                    <label class="cyber-label">PROTOCOL LEVEL</label>
                    <input type="text" class="cyber-input" id="newStudentGrade" 
                           placeholder="e.g., GRADE 5" required>
                </div>
                
                <div class="cyber-input-group">
                    <label class="cyber-label">GUARDIAN NEURAL LINK</label>
                    <input type="tel" class="cyber-input" id="newStudentContact" 
                           placeholder="Neural Frequency" required>
                </div>
                
                <div class="cyber-input-group">
                    <label class="cyber-label">INTERCEPT COORDINATES</label>
                    <input type="text" class="cyber-input" id="newStudentLocation" 
                           placeholder="Quantum Coordinates" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 32px;">
                    <button type="button" class="holo-action-btn" id="cancelAddStudent">
                        <i class="fas fa-times"></i> ABORT
                    </button>
                    <button type="submit" class="holo-action-btn primary">
                        <i class="fas fa-check"></i> ENROLL
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Neural Notifications -->
    <div class="quantum-modal" id="notificationsModal">
        <div class="modal-holo-content cyber-glass">
            <div style="text-align: center; margin-bottom: 32px;">
                <div class="hologram-icon" style="font-size: 32px; margin-bottom: 16px;">
                    <i class="fas fa-satellite-dish"></i>
                </div>
                <h2 class="holo-title">NEURAL FEED</h2>
                <p class="font-mono" style="opacity: 0.6; margin-top: 8px;">REAL-TIME SYSTEM ALERTS</p>
            </div>
            
            <div id="notificationsList" style="max-height: 300px; overflow-y: auto;">
                <!-- Neural alerts appear here -->
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 24px;">
                <button class="holo-action-btn" id="clearNotifications">
                    <i class="fas fa-trash"></i> PURGE
                </button>
                <button class="holo-action-btn" id="closeNotifications">
                    <i class="fas fa-times"></i> DISMISS
                </button>
            </div>
        </div>
    </div>

    <!-- Neural Toast Container -->
    <div class="neural-notifications" id="toastContainer"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ==================== QUANTUM CORE - NEXUS SYSTEM ====================
        const NEXUS_CONFIG = {
            apiKey: "AIzaSyCEnhJWNEpEkvQ3Oeuw3g6trXuz14zsK-U",
            authDomain: "schoolbus-tracker-pro.firebaseapp.com",
            databaseURL: "https://schoolbus-tracker-pro-default-rtdb.firebaseio.com",
            projectId: "schoolbus-tracker-pro",
            storageBucket: "schoolbus-tracker-pro.firebasestorage.app",
            messagingSenderId: "372498519858",
            appId: "1:372498519858:web:c1be826010b5cbf952292b"
        };

        // Initialize Quantum Core
        firebase.initializeApp(NEXUS_CONFIG);
        const quantumDB = firebase.database();

        // Nexus State
        const nexusState = {
            protocol: 'operator',
            operatorId: '',
            vehicleCode: '',
            guardianId: '',
            wardId: '',
            quantumTrip: 'to_academy',
            tripActive: false,
            neuralAlerts: [],
            visualSpectrum: 'cyberdark',
            wardsOnBoard: 0,
            totalWards: 0,
            neuralSignature: null,
            currentPosition: null
        };

        // Demo Wards Database
        let wardDatabase = {
            'WARD-001': {
                id: 'WARD-001',
                name: 'NEURAL PRIME',
                grade: 'GRADE 5',
                contact: '999-888-7777',
                location: 'QUANTUM DISTRICT',
                avatar: 'N',
                status: 'waiting',
                coordinates: [40.7188, -74.0160],
                school: 'QUANTUM ACADEMY'
            },
            'WARD-002': {
                id: 'WARD-002',
                name: 'CYBER NEXUS',
                grade: 'GRADE 4',
                contact: '999-888-7778',
                location: 'NEURAL ZONE',
                avatar: 'C',
                status: 'waiting',
                coordinates: [40.7088, -73.9960],
                school: 'QUANTUM ACADEMY'
            },
            'WARD-003': {
                id: 'WARD-003',
                name: 'MATRIX PROTOCOL',
                grade: 'GRADE 6',
                contact: '999-888-7779',
                location: 'DATA STREET',
                avatar: 'M',
                status: 'onbus',
                coordinates: [40.7028, -74.0260],
                school: 'QUANTUM ACADEMY'
            }
        };

        // Global Variables
        let quantumMap = null;
        let vehicleMarker = null;
        let quantumPath = null;
        let wardMarkers = [];
        let neuralWatchId = null;
        let neuralUpdateInterval = null;
        let isTripActive = false;

        // Initialize Quantum System
        document.addEventListener('DOMContentLoaded', function() {
            initNexus();
        });

        function initNexus() {
            setupQuantumAuth();
            updateQuantumClock();
            setInterval(updateQuantumClock, 1000);
            
            // Check for existing neural link
            const neuralLink = localStorage.getItem('nexus_neural_link');
            if (neuralLink) {
                const linkData = JSON.parse(neuralLink);
                establishNeuralLinkFromStorage(linkData);
            }
        }

        function setupQuantumAuth() {
            const operatorBtn = document.getElementById('driverRoleBtn');
            const guardianBtn = document.getElementById('parentRoleBtn');
            const quantumBtn = document.getElementById('loginBtn');

            operatorBtn.addEventListener('click', handleProtocolSelect);
            guardianBtn.addEventListener('click', handleProtocolSelect);
            quantumBtn.addEventListener('click', establishNeuralLink);
        }

        function handleProtocolSelect(e) {
            const isOperator = e.currentTarget.id === 'driverRoleBtn';
            nexusState.protocol = isOperator ? 'operator' : 'guardian';
            
            // Update hologram cards
            document.getElementById('driverRoleBtn').classList.toggle('active', isOperator);
            document.getElementById('parentRoleBtn').classList.toggle('active', !isOperator);
            
            // Update interface
            const loginLabel = document.getElementById('loginLabel');
            const parentExtra = document.getElementById('parentExtra');
            
            if (isOperator) {
                loginLabel.textContent = 'Operator Neural ID';
                parentExtra.style.display = 'none';
                document.getElementById('loginInput').value = 'OP-001';
            } else {
                loginLabel.textContent = 'Guardian Protocol';
                parentExtra.style.display = 'block';
                document.getElementById('loginInput').value = 'GUARDIAN-ALPHA';
            }
            
            // Add quantum feedback
            const btn = e.currentTarget;
            btn.style.transform = 'scale(0.95)';
            setTimeout(() => btn.style.transform = '', 150);
        }

        function establishNeuralLink() {
            if (nexusState.protocol === 'operator') {
                nexusState.operatorId = document.getElementById('loginInput').value.trim();
                nexusState.vehicleCode = document.getElementById('busNumber').value.trim();

                if (!nexusState.operatorId || !nexusState.vehicleCode) {
                    showQuantumAlert('Quantum fields required', 'error');
                    return;
                }

                nexusState.neuralSignature = `operator_${Date.now()}`;
                
                // Save neural link
                localStorage.setItem('nexus_neural_link', JSON.stringify({
                    protocol: 'operator',
                    neuralSignature: nexusState.neuralSignature,
                    operatorId: nexusState.operatorId,
                    vehicleCode: nexusState.vehicleCode
                }));

                activateInterface('operator');
                initOperatorProtocol();
                
                showQuantumAlert(`Neural link established: ${nexusState.operatorId}`, 'success');

            } else {
                nexusState.guardianId = document.getElementById('parentName').value.trim();
                nexusState.vehicleCode = document.getElementById('busNumber').value.trim();
                nexusState.wardId = document.getElementById('studentId').value.trim();

                if (!nexusState.guardianId || !nexusState.vehicleCode || !nexusState.wardId) {
                    showQuantumAlert('All quantum fields required', 'error');
                    return;
                }

                nexusState.neuralSignature = `guardian_${Date.now()}`;
                
                localStorage.setItem('nexus_neural_link', JSON.stringify({
                    protocol: 'guardian',
                    neuralSignature: nexusState.neuralSignature,
                    guardianId: nexusState.guardianId,
                    vehicleCode: nexusState.vehicleCode,
                    wardId: nexusState.wardId
                }));

                activateInterface('guardian');
                initGuardianProtocol();
                
                showQuantumAlert(`Guardian protocol active: ${nexusState.guardianId}`, 'success');
            }
        }

        function establishNeuralLinkFromStorage(linkData) {
            nexusState.protocol = linkData.protocol;
            nexusState.neuralSignature = linkData.neuralSignature;
            
            if (linkData.protocol === 'operator') {
                nexusState.operatorId = linkData.operatorId;
                nexusState.vehicleCode = linkData.vehicleCode;
                activateInterface('operator');
                initOperatorProtocol();
            } else {
                nexusState.guardianId = linkData.guardianId;
                nexusState.vehicleCode = linkData.vehicleCode;
                nexusState.wardId = linkData.wardId;
                activateInterface('guardian');
                initGuardianProtocol();
            }
            
            showQuantumAlert('Neural link restored', 'info');
        }

        function activateInterface(protocol) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.querySelectorAll('.interface').forEach(el => el.classList.remove('active'));
            document.getElementById(`${protocol}Interface`).classList.add('active');
        }

        // ==================== QUANTUM OPERATOR PROTOCOL ====================
        function initOperatorProtocol() {
            initQuantumMap('driverMap');
            setupOperatorControls();
            startQuantumGPS();
            
            // Initialize dashboard
            updateQuantumDashboard();
            
            // Start simulation if no GPS
            if (!navigator.geolocation) {
                startQuantumSimulation();
            }
        }

        function initQuantumMap(mapId) {
            const quantumCoords = [40.7128, -74.0060];
            
            quantumMap = L.map(mapId, {
                zoomControl: false,
                dragging: true,
                tap: true,
                touchZoom: true,
                doubleClickZoom: true,
                keyboard: false,
                inertia: true,
                fadeAnimation: true,
                markerZoomAnimation: true
            }).setView(quantumCoords, 14);
            
            // Set quantum map theme
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '© CARTO',
                maxZoom: 19,
                minZoom: 3
            }).addTo(quantumMap);
            
            // Create vehicle marker
            vehicleMarker = L.marker(quantumCoords, {
                icon: L.divIcon({
                    html: '<div class="quantum-pulse" style="width: 60px; height: 60px; border-radius: 16px; background: linear-gradient(135deg, var(--cyber-blue), var(--neon-purple)); display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; border: 3px solid white; box-shadow: 0 0 30px rgba(0, 212, 255, 0.5);"><i class="fas fa-shuttle-space"></i></div>',
                    className: 'quantum-vehicle',
                    iconSize: [60, 60],
                    iconAnchor: [30, 30]
                }),
                zIndexOffset: 1000
            }).addTo(quantumMap);
            
            // Initialize quantum path
            quantumPath = L.polyline([], {
                color: 'var(--cyber-blue)',
                weight: 4,
                opacity: 0.7,
                lineJoin: 'round',
                dashArray: '5, 10'
            }).addTo(quantumMap);
            
            // Add ward markers
            addWardMarkers();
        }

        function setupOperatorControls() {
            // Map controls
            document.getElementById('centerMap').addEventListener('click', centerQuantumVehicle);
            document.getElementById('zoomIn').addEventListener('click', () => quantumMap.zoomIn());
            document.getElementById('zoomOut').addEventListener('click', () => quantumMap.zoomOut());
            document.getElementById('showStudents').addEventListener('click', showWardManagement);
            document.getElementById('startTrip').addEventListener('click', toggleQuantumTrip);
            
            // Other controls
            document.getElementById('notificationsBtn').addEventListener('click', showNeuralFeed);
            document.getElementById('driverLogout').addEventListener('click', disconnectNeuralLink);
            
            // Ward management
            document.getElementById('closeStudentManagement').addEventListener('click', hideWardManagement);
            document.getElementById('addStudentBtn').addEventListener('click', showEnrollWardModal);
            document.getElementById('importStudentsBtn').addEventListener('click', batchImportWards);
            document.getElementById('addStudentForm').addEventListener('submit', handleEnrollWard);
            document.getElementById('cancelAddStudent').addEventListener('click', hideEnrollWardModal);
            
            // Notifications modal
            document.getElementById('clearNotifications').addEventListener('click', purgeNeuralFeed);
            document.getElementById('closeNotifications').addEventListener('click', hideNeuralFeedModal);
        }

        function startQuantumGPS() {
            if ('geolocation' in navigator) {
                neuralWatchId = navigator.geolocation.watchPosition(
                    handleQuantumPosition,
                    handleQuantumError,
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
                
                // Get initial position
                navigator.geolocation.getCurrentPosition(
                    handleQuantumPosition,
                    handleQuantumError,
                    { enableHighAccuracy: true }
                );
            } else {
                showQuantumAlert('GPS offline - Quantum simulation active', 'warning');
                startQuantumSimulation();
            }
        }

        function handleQuantumPosition(position) {
            nexusState.currentPosition = position;
            const { latitude, longitude, speed, heading } = position.coords;
            
            // Update vehicle
            const quantumCoords = [latitude, longitude];
            vehicleMarker.setLatLng(quantumCoords);
            
            // Update path
            const currentPath = quantumPath.getLatLngs();
            currentPath.push(quantumCoords);
            if (currentPath.length > 50) currentPath.shift();
            quantumPath.setLatLngs(currentPath);
            
            // Update quantum dashboard
            updateQuantumDashboard(speed);
            
            // Check nearby wards
            checkNearbyWards(quantumCoords);
            
            // Center on first position
            if (!window.quantumCentered) {
                quantumMap.setView(quantumCoords, 16);
                window.quantumCentered = true;
            }
        }

        function updateQuantumDashboard(speed = 0) {
            // Update speed
            const speedElement = document.getElementById('currentSpeed');
            const newSpeed = Math.round((speed || 0) * 3.6);
            speedElement.textContent = newSpeed;
            
            // Update ward counts
            const wardsOnBoard = Object.values(wardDatabase).filter(w => w.status === 'onbus').length;
            const totalWards = Object.keys(wardDatabase).length;
            document.getElementById('studentsCount').textContent = `${wardsOnBoard}/${totalWards}`;
            
            // Update next stop
            const nextStop = getNextStop();
            document.getElementById('nextStopName').textContent = nextStop || '--';
            
            // Update vehicle name
            document.getElementById('driverBusName').textContent = nexusState.vehicleCode;
        }

        function toggleQuantumTrip() {
            isTripActive = !isTripActive;
            const tripBtn = document.getElementById('startTrip');
            
            if (isTripActive) {
                tripBtn.classList.add('active');
                tripBtn.innerHTML = '<i class="fas fa-pause"></i>';
                showQuantumAlert('QUANTUM TRIP INITIATED', 'success');
            } else {
                tripBtn.classList.remove('active');
                tripBtn.innerHTML = '<i class="fas fa-play"></i>';
                showQuantumAlert('QUANTUM TRIP PAUSED', 'info');
            }
        }

        function centerQuantumVehicle() {
            if (quantumMap && vehicleMarker) {
                quantumMap.setView(vehicleMarker.getLatLng(), 16);
                showQuantumAlert('QUANTUM SYNCHRONIZATION COMPLETE', 'info');
            }
        }

        // ==================== QUANTUM GUARDIAN PROTOCOL ====================
        function initGuardianProtocol() {
            initQuantumMap('parentMap');
            setupGuardianControls();
            
            // Update child info
            updateChildInfo();
        }

        function setupGuardianControls() {
            document.getElementById('parentCenterMap').addEventListener('click', centerQuantumVehicle);
            document.getElementById('parentZoomIn').addEventListener('click', () => quantumMap.zoomIn());
            document.getElementById('parentZoomOut').addEventListener('click', () => quantumMap.zoomOut());
            document.getElementById('showRoute').addEventListener('click', toggleQuantumRoute);
            
            document.getElementById('markPickedBtn').addEventListener('click', () => updateWardStatus('onbus'));
            document.getElementById('markDroppedBtn').addEventListener('click', () => updateWardStatus('dropped'));
            
            document.getElementById('parentNotificationsBtn').addEventListener('click', showNeuralFeed);
            document.getElementById('parentLogout').addEventListener('click', disconnectNeuralLink);
        }

        function updateChildInfo() {
            const ward = wardDatabase[nexusState.wardId];
            if (!ward) {
                showQuantumAlert('WARD NOT FOUND IN DATABASE', 'error');
                return;
            }
            
            document.getElementById('childFullName').textContent = ward.name;
            document.getElementById('childSchool').textContent = ward.grade;
            document.getElementById('childAvatar').textContent = ward.avatar;
            document.getElementById('childLocation').textContent = 
                ward.status === 'onbus' ? 'ON QUANTUM VEHICLE' : `LOCATION: ${ward.location}`;
            
            const statusBadge = document.getElementById('childStatusBadge');
            statusBadge.className = `student-holo-status status-cyber-${ward.status}`;
            statusBadge.textContent = ward.status.toUpperCase();
        }

        function toggleQuantumRoute() {
            const btn = document.getElementById('showRoute');
            btn.classList.toggle('active');
            
            if (btn.classList.contains('active')) {
                quantumPath.addTo(quantumMap);
                showQuantumAlert('QUANTUM ROUTE VISIBLE', 'info');
            } else {
                quantumMap.removeLayer(quantumPath);
                showQuantumAlert('QUANTUM ROUTE HIDDEN', 'info');
            }
        }

        // ==================== QUANTUM WARD MANAGEMENT ====================
        function showWardManagement() {
            loadWardList();
            document.getElementById('studentManagement').classList.add('active');
        }

        function hideWardManagement() {
            document.getElementById('studentManagement').classList.remove('active');
        }

        function showEnrollWardModal() {
            document.getElementById('addStudentModal').classList.add('active');
        }

        function hideEnrollWardModal() {
            document.getElementById('addStudentModal').classList.remove('active');
            document.getElementById('addStudentForm').reset();
        }

        function handleEnrollWard(e) {
            e.preventDefault();
            
            const newWard = {
                id: document.getElementById('newStudentId').value,
                name: document.getElementById('newStudentName').value,
                grade: document.getElementById('newStudentGrade').value,
                contact: document.getElementById('newStudentContact').value,
                location: document.getElementById('newStudentLocation').value,
                avatar: document.getElementById('newStudentName').value.charAt(0).toUpperCase(),
                status: 'waiting',
                coordinates: [40.7128 + Math.random() * 0.01, -74.0060 + Math.random() * 0.01],
                school: 'QUANTUM ACADEMY',
                vehicleCode: nexusState.vehicleCode,
                enrolled: Date.now()
            };
            
            // Add to database
            wardDatabase[newWard.id] = newWard;
            
            // Update UI
            loadWardList();
            addWardMarkers();
            updateQuantumDashboard();
            hideEnrollWardModal();
            
            showQuantumAlert(`WARD ENROLLED: ${newWard.name}`, 'success');
        }

        function batchImportWards() {
            showQuantumAlert('BATCH IMPORT PROTOCOL INITIATED', 'info');
            // For demo, add some sample wards
            const sampleWards = [
                {
                    id: 'WARD-004',
                    name: 'SYNAPSE DELTA',
                    grade: 'GRADE 3',
                    contact: '999-888-7780',
                    location: 'NEURAL NET ZONE',
                    avatar: 'S',
                    status: 'waiting',
                    coordinates: [40.7288, -74.0360],
                    school: 'QUANTUM ACADEMY'
                },
                {
                    id: 'WARD-005',
                    name: 'PROTOCOL BETA',
                    grade: 'GRADE 7',
                    contact: '999-888-7781',
                    location: 'DATA CENTER',
                    avatar: 'P',
                    status: 'waiting',
                    coordinates: [40.6988, -73.9860],
                    school: 'QUANTUM ACADEMY'
                }
            ];
            
            sampleWards.forEach(ward => {
                wardDatabase[ward.id] = ward;
            });
            
            loadWardList();
            addWardMarkers();
            updateQuantumDashboard();
            
            showQuantumAlert(`BATCH IMPORT COMPLETE: ${sampleWards.length} WARDS ADDED`, 'success');
        }

        function loadWardList() {
            const container = document.getElementById('studentListContainer');
            const wards = Object.values(wardDatabase);
            
            if (wards.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div class="hologram-icon" style="margin-bottom: 16px;">
                            <i class="fas fa-user-slash"></i>
                        </div>
                        <p style="opacity: 0.6;">NO WARDS ENROLLED</p>
                        <button class="holo-action-btn primary" style="margin-top: 20px;" onclick="showEnrollWardModal()">
                            <i class="fas fa-plus"></i> ENROLL FIRST WARD
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = wards.map(ward => `
                <div class="student-holo-card">
                    <div class="student-holo-avatar">
                        ${ward.avatar}
                    </div>
                    <div class="student-holo-info">
                        <div class="student-holo-name">${ward.name}</div>
                        <div class="student-holo-details">
                            <span>${ward.grade}</span>
                            <span class="font-mono">•</span>
                            <span>${ward.location}</span>
                        </div>
                    </div>
                    <div class="student-holo-status status-cyber-${ward.status}">
                        ${ward.status.toUpperCase()}
                    </div>
                    <div class="student-actions-buttons">
                        <button class="hologram-btn" onclick="editWard('${ward.id}')" style="width: 40px; height: 40px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="hologram-btn" onclick="removeWard('${ward.id}')" style="width: 40px; height: 40px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function addWardMarkers() {
            // Clear existing markers
            if (wardMarkers.length > 0) {
                wardMarkers.forEach(marker => quantumMap.removeLayer(marker));
                wardMarkers = [];
            }
            
            // Add new markers
            Object.values(wardDatabase).forEach(ward => {
                const marker = L.marker(ward.coordinates, {
                    icon: L.divIcon({
                        html: `<div style="width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, var(--matrix-green), var(--cyber-blue)); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; border: 2px solid white; box-shadow: 0 0 20px rgba(0, 255, 157, 0.5);">${ward.avatar}</div>`,
                        className: 'ward-marker',
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    })
                }).addTo(quantumMap);
                
                marker.bindPopup(`
                    <div style="padding: 10px; font-family: 'Inter', sans-serif;">
                        <strong style="color: var(--cyber-blue);">${ward.name}</strong><br>
                        <span style="color: var(--matrix-green);">${ward.grade}</span><br>
                        <span style="color: rgba(255,255,255,0.7);">Status: ${ward.status.toUpperCase()}</span><br>
                        <span style="color: rgba(255,255,255,0.7);">Location: ${ward.location}</span>
                    </div>
                `);
                
                wardMarkers.push(marker);
            });
        }

        function updateWardStatus(status) {
            const ward = wardDatabase[nexusState.wardId];
            if (!ward) {
                showQuantumAlert('WARD NOT FOUND', 'error');
                return;
            }
            
            ward.status = status;
            
            // Update UI
            updateChildInfo();
            
            // Update markers
            addWardMarkers();
            
            // Update dashboard if operator
            if (nexusState.protocol === 'operator') {
                updateQuantumDashboard();
            }
            
            showQuantumAlert(`WARD STATUS UPDATED: ${status.toUpperCase()}`, 'success');
        }

        function editWard(wardId) {
            const ward = wardDatabase[wardId];
            showQuantumAlert(`EDIT WARD: ${ward.name}`, 'info');
            // In a full implementation, this would open an edit modal
        }

        function removeWard(wardId) {
            const ward = wardDatabase[wardId];
            if (!ward) return;
            
            if (confirm(`TERMINATE WARD PROTOCOL FOR ${ward.name}?`)) {
                delete wardDatabase[wardId];
                loadWardList();
                addWardMarkers();
                updateQuantumDashboard();
                showQuantumAlert(`WARD PROTOCOL TERMINATED: ${ward.name}`, 'success');
            }
        }

        // ==================== QUANTUM UTILITIES ====================
        function updateQuantumClock() {
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                           now.getMinutes().toString().padStart(2, '0') + ':' +
                           now.getSeconds().toString().padStart(2, '0');
            
            document.querySelectorAll('#currentTime, #parentTime').forEach(el => {
                if (el) el.textContent = timeStr;
            });
        }

        function showQuantumAlert(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const icons = {
                success: 'check-circle',
                error: 'exclamation-triangle',
                warning: 'radiation',
                info: 'info-circle'
            };
            
            const typeClass = `toast-holo-${type}`;
            
            toast.className = `neural-toast cyber-glass ${typeClass}`;
            toast.innerHTML = `
                <div class="toast-holo-icon">
                    <i class="fas fa-${icons[type] || 'info-circle'}"></i>
                </div>
                <div class="toast-message font-mono">${message}</div>
                <button class="hologram-btn" style="width: 32px; height: 32px; font-size: 12px;" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            // Show animation
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
            
            // Add to neural alerts
            nexusState.neuralAlerts.unshift({
                id: Date.now(),
                title: type.toUpperCase() + ' ALERT',
                message: message,
                type: type,
                timestamp: Date.now()
            });
            
            // Keep only last 20 alerts
            if (nexusState.neuralAlerts.length > 20) {
                nexusState.neuralAlerts.pop();
            }
        }

        function showNeuralFeed() {
            const modal = document.getElementById('notificationsModal');
            const list = document.getElementById('notificationsList');
            
            if (nexusState.neuralAlerts.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px 20px; opacity: 0.6;">NEURAL FEED QUIET</div>';
            } else {
                list.innerHTML = nexusState.neuralAlerts.map(alert => `
                    <div class="student-holo-card" style="margin-bottom: 8px;">
                        <div class="student-holo-avatar" style="background: ${alert.type === 'success' ? 'var(--matrix-green)' : alert.type === 'error' ? 'var(--critical-red)' : alert.type === 'warning' ? 'var(--warning-orange)' : 'var(--cyber-blue)'};">
                            <i class="fas fa-${alert.type === 'success' ? 'check' : alert.type === 'error' ? 'exclamation' : alert.type === 'warning' ? 'radiation' : 'info'}"></i>
                        </div>
                        <div style="flex: 1;">
                            <div class="student-holo-name">${alert.title}</div>
                            <div class="student-holo-details">${alert.message}</div>
                            <div class="student-holo-details" style="font-size: 11px; opacity: 0.6;">
                                ${new Date(alert.timestamp).toLocaleTimeString()}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            modal.classList.add('active');
        }

        function hideNeuralFeedModal() {
            document.getElementById('notificationsModal').classList.remove('active');
        }

        function purgeNeuralFeed() {
            nexusState.neuralAlerts = [];
            hideNeuralFeedModal();
            showQuantumAlert('NEURAL FEED PURGED', 'success');
        }

        function disconnectNeuralLink() {
            // Clean quantum connections
            if (neuralWatchId) {
                navigator.geolocation.clearWatch(neuralWatchId);
                neuralWatchId = null;
            }
            
            if (neuralUpdateInterval) {
                clearInterval(neuralUpdateInterval);
                neuralUpdateInterval = null;
            }
            
            // Reset UI
            document.getElementById('loginScreen').classList.remove('hidden');
            document.querySelectorAll('.interface').forEach(el => el.classList.remove('active'));
            document.getElementById('studentManagement').classList.remove('active');
            document.getElementById('addStudentModal').classList.remove('active');
            document.getElementById('notificationsModal').classList.remove('active');
            
            // Clear neural link
            localStorage.removeItem('nexus_neural_link');
            
            // Reset quantum state
            Object.keys(nexusState).forEach(key => {
                if (typeof nexusState[key] === 'boolean') {
                    nexusState[key] = false;
                } else if (typeof nexusState[key] === 'number') {
                    nexusState[key] = 0;
                } else if (Array.isArray(nexusState[key])) {
                    nexusState[key] = [];
                } else if (key !== 'protocol') {
                    nexusState[key] = null;
                }
            });
            
            nexusState.protocol = 'operator';
            
            showQuantumAlert('NEURAL LINK DISCONNECTED', 'info');
        }

        // ==================== QUANTUM SIMULATION ====================
        function startQuantumSimulation() {
            let simLat = 40.7128;
            let simLng = -74.0060;
            let simIndex = 0;
            
            neuralUpdateInterval = setInterval(() => {
                simLat += 0.0001 * (Math.random() > 0.5 ? 1 : -1);
                simLng += 0.0001 * (Math.random() > 0.5 ? 1 : -1);
                simIndex++;
                
                const simPosition = {
                    coords: {
                        latitude: simLat,
                        longitude: simLng,
                        speed: 12 + Math.random() * 6,
                        heading: (simIndex * 15) % 360
                    }
                };
                
                if (nexusState.protocol === 'operator') {
                    handleQuantumPosition(simPosition);
                }
                
                // Auto-update random ward status
                if (simIndex % 15 === 0) {
                    const wards = Object.values(wardDatabase);
                    if (wards.length > 0) {
                        const randomWard = wards[Math.floor(Math.random() * wards.length)];
                        if (randomWard.status === 'waiting') {
                            randomWard.status = 'onbus';
                            showQuantumAlert(`${randomWard.name} INTERCEPTED`, 'success');
                        } else if (randomWard.status === 'onbus' && Math.random() > 0.7) {
                            randomWard.status = 'dropped';
                            showQuantumAlert(`${randomWard.name} DELIVERED`, 'info');
                        }
                        
                        // Update dashboard
                        updateQuantumDashboard();
                        
                        // Update child info if guardian
                        if (nexusState.protocol === 'guardian' && randomWard.id === nexusState.wardId) {
                            updateChildInfo();
                        }
                    }
                }
            }, 2000);
        }

        function handleQuantumError(error) {
            let message = 'QUANTUM GPS OFFLINE';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'LOCATION PERMISSION DENIED';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'LOCATION UNAVAILABLE';
                    break;
                case error.TIMEOUT:
                    message = 'LOCATION REQUEST TIMEOUT';
                    break;
            }
            
            showQuantumAlert(message + ' - SIMULATION ACTIVE', 'warning');
            startQuantumSimulation();
        }

        function checkNearbyWards(busCoords) {
            Object.values(wardDatabase).forEach(ward => {
                const distance = quantumMap.distance(busCoords, ward.coordinates);
                
                if (distance < 100 && ward.status === 'waiting') {
                    ward.status = 'onbus';
                    showQuantumAlert(`AUTO-INTERCEPT: ${ward.name}`, 'success');
                    
                    // Update dashboard
                    updateQuantumDashboard();
                    
                    // Update markers
                    addWardMarkers();
                }
            });
        }

        function getNextStop() {
            const waitingWards = Object.values(wardDatabase)
                .filter(w => w.status === 'waiting');
            
            if (waitingWards.length === 0) return null;
            
            // Simple algorithm: find nearest waiting ward
            if (nexusState.currentPosition) {
                const busCoords = [nexusState.currentPosition.coords.latitude, nexusState.currentPosition.coords.longitude];
                let nearest = waitingWards[0];
                let minDistance = Infinity;
                
                waitingWards.forEach(ward => {
                    const distance = quantumMap.distance(busCoords, ward.coordinates);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearest = ward;
                    }
                });
                
                return nearest.location;
            }
            
            return waitingWards[0].location;
        }

        // Initialize quantum system
        setTimeout(() => {
            showQuantumAlert('QUANTUM SYSTEM ONLINE', 'success');
            showQuantumAlert('NEXUS SECURITY ACTIVE', 'info');
        }, 1000);

        // Make functions available globally
        window.editWard = editWard;
        window.removeWard = removeWard;
        window.updateWardStatus = updateWardStatus;
        window.showEnrollWardModal = showEnrollWardModal;
    </script>
</body>
</html>
